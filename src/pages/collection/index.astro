---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CardThumbnail from '../../components/CardThumbnail.astro';
import CollectingModeToggle from '../../components/CollectingModeToggle.astro';
import { getCollection } from 'astro:content';
import { getTierColor, RARITY_MAP, RARITY_RANK, RAINBOW_GRADIENT } from '../../utils/rarity.ts';

const allSets = await getCollection('sets');
const allCardGroups = await getCollection('cards');
const allCards = allCardGroups.flatMap(g => g.data);

// Build set data with card info
const setsData = allSets.map(s => {
  const cardGroup = allCardGroups.find(g => g.id === s.data.slug || g.id === s.data.id);
  const cards = cardGroup ? cardGroup.data : [];
  return {
    id: s.data.id,
    slug: s.data.slug,
    name: s.data.displayName || s.data.name,
    tier: s.data.tier,
    cardCount: cards.length,
    cardIds: cards.map(c => c.id),
    tierColor: getTierColor(s.data.tier),
    language: s.data.language,
  };
}).sort((a, b) => a.name.localeCompare(b.name));

const totalCards = allCards.length;

// Build all-cards data for the "All Owned" tab
const allCardsData = allCards.map(c => {
  const set = allSets.find(s => s.data.id === c.setId);
  return {
    id: c.id,
    slug: c.slug,
    name: c.name,
    rarity: c.rarity,
    setName: set?.data.displayName || set?.data.name || c.setId,
    image: c.image,
    language: set?.data.language || 'CN',
  };
});
---

<BaseLayout title="My Collection" description="Track your KAYOU Naruto card collection. See progress per set, export and import your collection.">

  <h1 class="text-3xl sm:text-4xl font-bangers tracking-wider text-white mb-2">My Collection</h1>
  <p class="text-brand-text-muted mb-8">Track your KAYOU Naruto card collection. Data is stored locally in your browser &mdash; no account needed.</p>

  <CollectingModeToggle />

  <!-- Overall Stats -->
  <div class="bg-brand-surface rounded-xl border border-brand-border p-6 mb-6">
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
      <div>
        <h2 class="text-lg font-bangers tracking-wider text-white">Overall Completion</h2>
        <p class="text-3xl font-bangers text-brand-orange" id="total-progress">0 / {totalCards} cards</p>
        <p class="text-xs text-brand-text-muted mt-1">
          <span id="wishlist-count">0</span> cards on wishlist
        </p>
      </div>
      <div class="flex gap-3 flex-wrap">
        <button id="export-btn" class="px-4 py-2 bg-brand-surface-light border border-brand-border rounded-lg text-sm font-bold text-brand-text-muted hover:text-white hover:border-brand-orange transition-all">
          ðŸ“¥ Export JSON
        </button>
        <label class="px-4 py-2 bg-brand-surface-light border border-brand-border rounded-lg text-sm font-bold text-brand-text-muted hover:text-white hover:border-brand-orange transition-all cursor-pointer">
          ðŸ“¤ Import JSON
          <input type="file" id="import-input" accept=".json" class="hidden" />
        </label>
      </div>
    </div>
    <div class="w-full h-3 bg-brand-bg rounded-full overflow-hidden">
      <div class="h-full bg-brand-orange rounded-full transition-all duration-500" id="total-bar" style="width: 0%"></div>
    </div>
  </div>

  <!-- Tabs and Global Filters -->
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
    <div class="flex gap-2">
      <button id="tab-sets" class="px-4 py-2 rounded-lg text-sm font-bold bg-brand-orange text-white transition-all">
        <span class="tab-label-set">By Set</span>
        <span class="tab-label-rarity hidden">By Rarity</span>
      </button>
      <button id="tab-owned" class="px-4 py-2 rounded-lg text-sm font-bold bg-brand-surface text-brand-text-muted border border-brand-border hover:text-white transition-all">All Owned</button>
    </div>
    <div class="flex items-center gap-2">
      <label class="text-sm font-bold text-brand-text-muted uppercase tracking-wider">Language</label>
      <select id="global-lang-filter" class="bg-brand-bg border border-brand-border rounded-lg px-3 py-1.5 text-sm text-white font-rajdhani focus:border-brand-orange outline-none">
        <option value="">All</option>
        <option value="EN">English</option>
        <option value="CN">Chinese</option>
      </select>
    </div>
  </div>

  <!-- Tab 1: By Set -->
  <div id="view-sets">
    <!-- Filter -->
    <div class="flex items-center gap-4 mb-4">
      <label class="flex items-center gap-2 text-sm text-brand-text-muted cursor-pointer">
        <input type="checkbox" id="filter-incomplete" class="accent-brand-orange" />
        <span>Show only incomplete sets</span>
      </label>
    </div>

    <div class="space-y-3" id="set-list">
      {setsData.map(set => (
        <div class="set-progress-row bg-brand-surface rounded-lg border border-brand-border p-4 transition-all hover:border-brand-border"
             data-set-id={set.id}
             data-card-ids={JSON.stringify(set.cardIds)}
             data-card-count={set.cardCount}
             data-language={set.language}>
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <div class="w-1 h-6 rounded-full" style={`background: ${set.tierColor}`}></div>
              <a href={`/sets/${set.slug}/`} class="text-sm font-semibold text-white hover:text-brand-orange transition-colors">{set.name}</a>
              <span class="text-[10px] font-bold px-1.5 py-0.5 rounded" style={`background: ${set.tierColor}20; color: ${set.tierColor}`}>{set.tier}</span>
            </div>
            <span class="set-count text-xs font-mono text-brand-text-muted">0 / {set.cardCount}</span>
          </div>
          <div class="w-full h-1.5 bg-brand-bg rounded-full overflow-hidden">
            <div class="set-bar h-full rounded-full transition-all duration-500" style={`width: 0%; background: ${set.tierColor}`}></div>
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Rarity View (replaces tab 1 dynamically based on mode) -->
  <div id="view-rarity" class="hidden">
    <!-- Highlights Panel -->
    <div id="rarity-highlights" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

    <div class="flex items-center gap-4 mb-4">
      <label class="text-sm font-bold text-brand-text-muted uppercase tracking-wider">Sort</label>
      <select id="rarity-sort" class="bg-brand-bg border border-brand-border rounded-lg px-3 py-1.5 text-xs text-white font-rajdhani focus:border-brand-orange outline-none">
        <option value="rarest">Rarest First</option>
        <option value="most">Most Complete First</option>
        <option value="least">Least Complete First</option>
        <option value="alpha">Alphabetical</option>
      </select>
    </div>

    <!-- Rarity List -->
    <div class="space-y-3" id="rarity-list">
      <p class="text-sm text-brand-text-muted">Loading rarity progress...</p>
    </div>
  </div>

  <!-- Tab 2: All Owned -->
  <div id="view-owned" class="hidden">
    <p class="text-sm text-brand-text-muted mb-4" id="owned-label">Loading...</p>
    <div id="owned-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
    </div>
    <div id="owned-empty" class="hidden text-center py-12 text-brand-text-muted">
      <p class="text-lg font-semibold">No cards owned yet</p>
      <p class="text-sm mt-1">Browse sets and start adding cards to your collection!</p>
    </div>
  </div>

  <script id="page-data" type="application/json" set:html={JSON.stringify({
    totalCards,
    allCardsData,
    rarityMap: Object.fromEntries(Object.entries(RARITY_MAP).map(([k,v]) => [k, { color: v.color, isGradient: v.isGradient, label: v.label, rank: v.sortOrder }])),
    rainbowGradient: RAINBOW_GRADIENT
  })}></script>

  <script>
    import { getCollectingMode } from '../../utils/collectingMode';
    import { getRarityProgress } from '../../utils/rarityProgress';

    const rawData = document.getElementById('page-data')?.textContent;
    const { totalCards, allCardsData, rarityMap, rainbowGradient } = rawData ? JSON.parse(rawData) : { totalCards: 0, allCardsData: [], rarityMap: {}, rainbowGradient: '' };

    // Tab switching
    const tabSets = document.getElementById('tab-sets');
    const tabOwned = document.getElementById('tab-owned');
    const viewSets = document.getElementById('view-sets');
    const viewRarity = document.getElementById('view-rarity');
    const viewOwned = document.getElementById('view-owned');

    let currentMode = getCollectingMode();

    function showMainTab() {
      tabSets?.classList.add('bg-brand-orange', 'text-white');
      tabSets?.classList.remove('bg-brand-surface', 'text-brand-text-muted', 'border', 'border-brand-border');
      tabOwned?.classList.remove('bg-brand-orange', 'text-white');
      tabOwned?.classList.add('bg-brand-surface', 'text-brand-text-muted', 'border', 'border-brand-border');
      
      viewOwned?.classList.add('hidden');
      
      if (currentMode === 'rarity') {
        viewSets?.classList.add('hidden');
        viewRarity?.classList.remove('hidden');
        document.querySelector('.tab-label-set')?.classList.add('hidden');
        document.querySelector('.tab-label-rarity')?.classList.remove('hidden');
        renderRarityProgress();
      } else {
        viewSets?.classList.remove('hidden');
        viewRarity?.classList.add('hidden');
        document.querySelector('.tab-label-set')?.classList.remove('hidden');
        document.querySelector('.tab-label-rarity')?.classList.add('hidden');
        updateCollectionUI();
      }
    }

    tabSets?.addEventListener('click', showMainTab);

    tabOwned?.addEventListener('click', () => {
      tabOwned.classList.add('bg-brand-orange', 'text-white');
      tabOwned.classList.remove('bg-brand-surface', 'text-brand-text-muted', 'border', 'border-brand-border');
      tabSets?.classList.remove('bg-brand-orange', 'text-white');
      tabSets?.classList.add('bg-brand-surface', 'text-brand-text-muted', 'border', 'border-brand-border');
      viewOwned?.classList.remove('hidden');
      viewSets?.classList.add('hidden');
      viewRarity?.classList.add('hidden');
      renderOwned();
    });

    function updateCollectionUI() {
      try {
        const raw = localStorage.getItem('naruto-collector-v3');
        const data = raw ? JSON.parse(raw) : { owned: {}, wishlist: {} };
        const owned = data.owned || {};
        const wishlist = data.wishlist || {};
        const totalOwned = Object.keys(owned).length;
        const totalWish = Object.keys(wishlist).length;

        document.getElementById('total-progress').textContent = `${totalOwned} / ${totalCards} cards`;
        document.getElementById('total-bar').style.width = `${totalCards > 0 ? Math.round((totalOwned / totalCards) * 100) : 0}%`;
        document.getElementById('wishlist-count').textContent = String(totalWish);

        // Per-set progress
        document.querySelectorAll('.set-progress-row').forEach(row => {
          const cardIds = JSON.parse(row.getAttribute('data-card-ids'));
          const count = parseInt(row.getAttribute('data-card-count'));
          const setOwned = cardIds.filter(id => owned[id]).length;
          const pct = count > 0 ? Math.round((setOwned / count) * 100) : 0;
          row.querySelector('.set-count').textContent = `${setOwned} / ${count}`;
          row.querySelector('.set-bar').style.width = `${pct}%`;
          row.setAttribute('data-owned', setOwned);
          row.setAttribute('data-complete', setOwned >= count ? '1' : '0');
        });
      } catch(e) {}
    }

    function renderOwned() {
      const raw = localStorage.getItem('naruto-collector-v3');
      const data = raw ? JSON.parse(raw) : { owned: {} };
      const ownedIds = Object.keys(data.owned || {});
      const grid = document.getElementById('owned-grid');
      const label = document.getElementById('owned-label');
      const empty = document.getElementById('owned-empty');
      const langFilter = document.getElementById('global-lang-filter')?.value;

      let ownedCards = allCardsData.filter(c => ownedIds.includes(c.id));
      if (langFilter) {
        ownedCards = ownedCards.filter(c => c.language === langFilter);
      }

      if (ownedCards.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        label.textContent = '';
        return;
      }

      empty.classList.add('hidden');
      label.textContent = `${ownedCards.length} cards owned`;

      grid.innerHTML = ownedCards.map(c => {
        const ri = rarityMap[c.rarity] || { color: '#6b7280', isGradient: false };
        const badgeStyle = ri.isGradient
          ? 'background: linear-gradient(135deg, #f97316, #ec4899, #8b5cf6, #3b82f6); color: white;'
          : `background: ${ri.color}20; color: ${ri.color};`;
        return `
          <a href="/cards/${c.slug}/" class="bg-brand-surface rounded-xl border border-brand-border overflow-hidden card-hover block">
            <div class="aspect-[5/7] relative overflow-hidden bg-brand-bg">
              <img src="${c.image}" alt="${c.name}" class="w-full h-full object-cover" loading="lazy"
                onerror="this.src='/images/placeholder/${c.rarity.toLowerCase()}.svg'" />
              <span class="absolute top-1.5 right-1.5 text-[10px] font-bold px-1.5 py-0.5 rounded-full" style="${badgeStyle}">${c.rarity}</span>
              <span class="absolute top-1.5 left-1.5 text-green-400 text-sm">âœ“</span>
            </div>
            <div class="p-2">
              <div class="text-xs font-semibold text-white truncate">${c.name}</div>
              <div class="text-[10px] text-brand-text-muted truncate">${c.setName}</div>
            </div>
          </a>
        `;
      }).join('');
    }

    updateCollectionUI();
    if (currentMode === 'rarity') {
      renderRarityProgress();
    }
    
    window.addEventListener('collection-updated', () => {
      updateCollectionUI();
      if (currentMode === 'rarity') renderRarityProgress();
      if (!viewOwned?.classList.contains('hidden')) renderOwned();
    });

    window.addEventListener('collecting-mode-change', (e) => {
      currentMode = e.detail.mode;
      if (!viewOwned?.classList.contains('hidden')) {
        // Just update labels if we are on the Owned tab
        if (currentMode === 'rarity') {
          document.querySelector('.tab-label-set')?.classList.add('hidden');
          document.querySelector('.tab-label-rarity')?.classList.remove('hidden');
        } else {
          document.querySelector('.tab-label-set')?.classList.remove('hidden');
          document.querySelector('.tab-label-rarity')?.classList.add('hidden');
        }
      } else {
        showMainTab();
      }
    });

    // Rarity Progress Rendering
    function renderRarityProgress() {
      const rl = document.getElementById('rarity-list');
      const hl = document.getElementById('rarity-highlights');
      if (!rl || !hl) return;

      const raw = localStorage.getItem('naruto-collector-v3');
      const data = raw ? JSON.parse(raw) : { owned: {} };
      
      const progress = getRarityProgress(data, allCardsData);
      const sort = document.getElementById('rarity-sort')?.value || 'rarest';
      
      let sorted = [...progress];
      if (sort === 'most') sorted.sort((a,b) => b.percent - a.percent);
      else if (sort === 'least') sorted.sort((a,b) => a.percent - b.percent);
      else if (sort === 'alpha') sorted.sort((a,b) => a.rarity.localeCompare(b.rarity));
      // rarest is default, already sorted

      // Filter out zero-total
      sorted = sorted.filter(p => p.total > 0);

      rl.innerHTML = sorted.map(p => {
        const rmap = rarityMap[p.rarity] || { color: '#6b7280', isGradient: false };
        const badgeStyle = rmap.isGradient
          ? `background: ${rainbowGradient}; color: white;`
          : `background: ${rmap.color}20; color: ${rmap.color}; border: 1px solid ${rmap.color}40;`;
        
        return `
        <div class="bg-brand-surface rounded-lg border border-brand-border p-4 transition-all">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <span class="text-[10px] font-bold px-1.5 py-0.5 rounded" style="${badgeStyle}">${p.rarity}</span>
              <span class="text-sm font-semibold text-white">${p.rarityName}</span>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-xs font-mono text-brand-text-muted">${p.owned} / ${p.total}</span>
              <span class="text-xs font-bold ${p.percent === 100 ? 'text-green-400' : 'text-brand-orange'}">${p.percent}%</span>
              <button class="text-[10px] font-bold uppercase tracking-wider text-brand-orange hover:text-white transition-colors" onclick="alert('Drill-down coming soon or inline expansion')">
                View â€º
              </button>
            </div>
          </div>
          <div class="w-full h-1.5 bg-brand-bg rounded-full overflow-hidden">
            <div class="h-full rounded-full transition-all duration-500" style="width: ${p.percent}%; ${rmap.isGradient ? `background: ${rainbowGradient}` : `background: ${rmap.color}`}"></div>
          </div>
        </div>`;
      }).join('');

      // Render Highlights
      const mostComplete = [...progress].filter(p => p.total > 5 && p.percent > 0).sort((a,b) => b.percent - a.percent)[0];
      const rarestOwned = [...progress].filter(p => p.owned > 0).sort((a,b) => rarityMap[a.rarity]?.rank - rarityMap[b.rarity]?.rank)[0]; // Lowest rank obj = rarest
      const nearestFinish = [...progress].filter(p => p.total > 5 && p.percent >= 50 && p.percent < 100).sort((a,b) => b.percent - a.percent)[0];
      const uniqueCollected = progress.filter(p => p.owned > 0).length;

      hl.innerHTML = `
        <div class="bg-brand-surface border border-brand-border rounded-lg p-3">
          <p class="text-[10px] text-brand-text-muted uppercase tracking-wider font-bold mb-1">Most Complete</p>
          <p class="text-sm text-white font-semibold flex items-center gap-2">
            ${mostComplete ? `${mostComplete.rarity} <span class="text-xs text-brand-text-muted font-normal">â€” ${mostComplete.percent}% (${mostComplete.owned}/${mostComplete.total})</span>` : 'N/A'}
          </p>
        </div>
        <div class="bg-brand-surface border border-brand-border rounded-lg p-3">
          <p class="text-[10px] text-brand-text-muted uppercase tracking-wider font-bold mb-1">Rarest Owned</p>
          <p class="text-sm text-brand-gold font-semibold flex items-center gap-2">
            ${rarestOwned ? `ðŸ’Ž ${rarestOwned.rarity} <span class="text-xs text-brand-text-muted font-normal">â€” ${rarestOwned.owned} cards</span>` : 'N/A'}
          </p>
        </div>
        <div class="bg-brand-surface border border-brand-border rounded-lg p-3">
          <p class="text-[10px] text-brand-text-muted uppercase tracking-wider font-bold mb-1">Closest to Complete</p>
          <p class="text-sm text-white font-semibold flex items-center gap-2">
            ${nearestFinish ? `ðŸŽ¯ ${nearestFinish.rarity} <span class="text-xs text-brand-text-muted font-normal">â€” ${nearestFinish.missing} more to finish</span>` : 'N/A'}
          </p>
        </div>
        <div class="bg-brand-surface border border-brand-border rounded-lg p-3">
          <p class="text-[10px] text-brand-text-muted uppercase tracking-wider font-bold mb-1">Unique Rarities</p>
          <p class="text-sm text-white font-semibold flex items-center gap-2">
            ðŸ“‹ ${uniqueCollected} / ${progress.length}
          </p>
        </div>
      `;
    }

    document.getElementById('rarity-sort')?.addEventListener('change', renderRarityProgress);

    // Sort sets by % incomplete (most incomplete first)
    function sortSetsByIncomplete() {
      const setList = document.getElementById('set-list');
      if (!setList) return;
      const rows = Array.from(setList.querySelectorAll('.set-progress-row'));
      rows.sort((a, b) => {
        const aCount = parseInt(a.getAttribute('data-card-count') || '0');
        const aOwned = parseInt(a.getAttribute('data-owned') || '0');
        const bCount = parseInt(b.getAttribute('data-card-count') || '0');
        const bOwned = parseInt(b.getAttribute('data-owned') || '0');
        const aPct = aCount > 0 ? aOwned / aCount : 1;
        const bPct = bCount > 0 ? bOwned / bCount : 1;
        return aPct - bPct; // least complete first
      });
      rows.forEach(row => setList.appendChild(row));
    }
    sortSetsByIncomplete();

    // Apply Filters
    function applySetFilters() {
      const filterOn = document.getElementById('filter-incomplete')?.checked;
      const langFilter = document.getElementById('global-lang-filter')?.value;
      
      document.querySelectorAll('.set-progress-row').forEach(row => {
        const count = parseInt(row.getAttribute('data-card-count') || '0');
        const owned = parseInt(row.getAttribute('data-owned') || '0');
        const lang = row.getAttribute('data-language');
        
        let show = true;
        if (filterOn && owned >= count) show = false;
        if (langFilter && lang !== langFilter) show = false;
        
        row.style.display = show ? '' : 'none';
      });
    }

    document.getElementById('filter-incomplete')?.addEventListener('change', applySetFilters);
    document.getElementById('global-lang-filter')?.addEventListener('change', () => {
      applySetFilters();
      renderOwned();
    });

    // Export
    document.getElementById('export-btn')?.addEventListener('click', () => {
      const raw = localStorage.getItem('naruto-collector-v3') || '{}';
      const data = JSON.parse(raw);
      data.lastExported = new Date().toISOString();
      data._addCountSinceExport = 0;
      localStorage.setItem('naruto-collector-v3', JSON.stringify(data));

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `naruto-collection-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);

      // Hide backup warning
      document.getElementById('backup-warning')?.classList.add('hidden');
    });

    // Import
    document.getElementById('import-input')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (data.owned) {
            localStorage.setItem('naruto-collector-v3', JSON.stringify(data));
            updateCollectionUI();
            renderOwned();
            alert('Collection imported successfully!');
          } else {
            alert('Invalid collection file.');
          }
        } catch(err) {
          alert('Error reading file.');
        }
      };
      reader.readAsText(file);
    });
  </script>
</BaseLayout>
