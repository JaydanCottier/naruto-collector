---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { FIGURE_TYPE_LABELS, FIGURE_TYPE_COLORS } from '../../utils/rarity';

const allFigures = await getCollection('figures');
const figures = allFigures[0]?.data || [];

const grouped = {
  regular: figures.filter((f: any) => f.figureType === 'regular'),
  eternal: figures.filter((f: any) => f.figureType === 'eternal'),
  ultimate: figures.filter((f: any) => f.figureType === 'ultimate'),
  big: figures.filter((f: any) => f.figureType === 'big'),
  'chase-small': figures.filter((f: any) => f.figureType === 'chase-small'),
};
---

<BaseLayout title="Figure Collection" description="Track your KAYOU Naruto figure blind box collection. 86 figures across 5 types.">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bangers tracking-wider text-white">ğŸ­ Figure Collection</h1>
        <p class="text-sm text-brand-text-muted mt-1">Track your KAYOU Naruto figure blind box collection. 86 figures total.</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="bg-brand-surface border border-brand-border rounded-xl px-4 py-2">
          <span class="text-xs text-brand-text-muted block">Collected</span>
          <span id="figure-progress" class="text-lg font-bangers text-brand-orange">0 / 86</span>
        </div>
        <div class="w-32 h-2 bg-brand-surface rounded-full overflow-hidden border border-brand-border">
          <div id="figure-bar" class="h-full bg-gradient-to-r from-brand-orange to-orange-400 transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Buy CTA -->
    <div class="bg-emerald-900/30 border border-emerald-700/50 rounded-xl p-4 mb-8 flex items-center gap-3">
      <span class="text-2xl">ğŸ</span>
      <div>
        <p class="text-sm font-semibold text-emerald-300">Buy Figure Blind Boxes</p>
        <p class="text-xs text-brand-text-muted">Each box: 1 blind figure + 1 exclusive XP rarity card (~$10). 12-pack: 10 regular + 1 eternal + 1 chase guaranteed.</p>
      </div>
      <a href="/sets/figure-blind-box/" class="ml-auto px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-semibold rounded-lg transition-colors whitespace-nowrap">View Set â†’</a>
    </div>

    <!-- Figure Type Groups -->
    {Object.entries(grouped).map(([type, figs]) => (
      figs.length > 0 && (
        <section class="mb-10">
          <div class="flex items-center gap-3 mb-4">
            <span class="inline-block w-3 h-3 rounded-full" style={`background: ${FIGURE_TYPE_COLORS[type]}`}></span>
            <h2 class="text-xl font-bangers tracking-wider text-white">{FIGURE_TYPE_LABELS[type]} ({figs.length})</h2>
          </div>
          <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3">
            {figs.map((fig: any) => (
              <button
                class="figure-card group relative bg-brand-surface border border-brand-border rounded-xl p-3 text-center hover:border-brand-orange/50 transition-all cursor-pointer"
                data-figure-id={fig.id}
                data-figure-type={fig.figureType}
              >
                <div class="w-12 h-12 mx-auto mb-2 rounded-full flex items-center justify-center text-2xl" style={`background: ${FIGURE_TYPE_COLORS[fig.figureType]}20`}>
                  ğŸ­
                </div>
                <p class="text-xs font-semibold text-white truncate">{fig.name}</p>
                <p class="text-[10px] text-brand-text-muted truncate">{fig.character}</p>
                <div class="owned-check absolute top-1 right-1 w-5 h-5 rounded-full bg-emerald-500 text-white text-xs flex items-center justify-center opacity-0 transition-opacity">âœ“</div>
              </button>
            ))}
          </div>
        </section>
      )
    ))}
  </div>

  <script>
    function getFigureCollection() {
      try {
        const raw = localStorage.getItem('naruto-collector-v3');
        if (!raw) return {};
        const data = JSON.parse(raw);
        return data.figures || {};
      } catch { return {}; }
    }

    function saveFigureOwned(figureId, figureType) {
      const raw = localStorage.getItem('naruto-collector-v3') || '{"version":3,"lastModified":"","owned":{},"wishlist":{},"figures":{},"lastExported":null}';
      const data = JSON.parse(raw);
      if (!data.figures) data.figures = {};

      if (data.figures[figureId]?.owned) {
        delete data.figures[figureId];
      } else {
        data.figures[figureId] = {
          owned: true,
          variant: figureType,
          quantity: 1,
          addedAt: new Date().toISOString(),
        };
      }
      data.lastModified = new Date().toISOString();
      localStorage.setItem('naruto-collector-v3', JSON.stringify(data));
      return data.figures[figureId]?.owned || false;
    }

    function updateUI() {
      const figures = getFigureCollection();
      const count = Object.values(figures).filter(f => f.owned).length;
      const pct = Math.round((count / 86) * 100);

      document.getElementById('figure-progress').textContent = `${count} / 86`;
      document.getElementById('figure-bar').style.width = `${pct}%`;

      document.querySelectorAll('.figure-card').forEach(card => {
        const id = card.dataset.figureId;
        const check = card.querySelector('.owned-check');
        if (figures[id]?.owned) {
          check.style.opacity = '1';
          card.classList.add('border-emerald-500/50', 'bg-emerald-900/10');
          card.classList.remove('border-brand-border');
        } else {
          check.style.opacity = '0';
          card.classList.remove('border-emerald-500/50', 'bg-emerald-900/10');
          card.classList.add('border-brand-border');
        }
      });
    }

    document.querySelectorAll('.figure-card').forEach(card => {
      card.addEventListener('click', () => {
        const id = card.dataset.figureId;
        const type = card.dataset.figureType;
        saveFigureOwned(id, type);
        updateUI();
      });
    });

    updateUI();
  </script>
</BaseLayout>
