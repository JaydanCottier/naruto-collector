---
import BaseLayout from './BaseLayout.astro';
import PullRateCard from '../components/sets/PullRateCard.astro';
import BuyButton from '../components/affiliate/BuyButton.astro';
import AffiliateDisclosure from '../components/affiliate/AffiliateDisclosure.astro';
import CompleteYourSet from '../components/sets/CompleteYourSet.astro';

interface Props {
  set: any;
  cards: any[];
}

const { set, cards } = Astro.props;
const { getTierColor } = await import('../utils/rarity.ts');
const tierColor = getTierColor(set.tier);
const link = set.affiliateLinks?.aliexpress || '#';
const price = set.affiliateLinks?.approxPriceUSD || 0;
const cardIds = cards.map((c: any) => c.id);
const isUnsealed = set.unsealed === true;
const isPoorHitRate = set.pullRates?.valueRating === 1;
const valueStars = set.pullRates?.valueRating || 3;
---

<BaseLayout title={`${set.displayName || set.name} â€” Set Details`} description={set.description}>
  <!-- Set Header -->
  <div class="relative rounded-2xl overflow-hidden mb-8 border border-brand-border">
    <div class="absolute inset-0 bg-brand-surface"></div>
    <div class="absolute inset-0 opacity-10 bg-cover bg-center" style={`background-image: url('${set.bannerImage}')`}></div>
    <div class="absolute inset-0 bg-gradient-to-r from-brand-bg via-brand-bg/80 to-transparent"></div>

    <div class="relative p-6 sm:p-8">
      <!-- Breadcrumb -->
      <nav class="text-xs text-brand-text-muted mb-4 font-semibold">
        <a href="/" class="hover:text-white transition-colors">Home</a>
        <span class="mx-2">â€º</span>
        <a href="/sets" class="hover:text-white transition-colors">Sets</a>
        <span class="mx-2">â€º</span>
        <span class="text-white">{set.displayName || set.name}</span>
      </nav>

      <div class="flex flex-col lg:flex-row lg:items-end gap-6 justify-between">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-2 flex-wrap">
            <span class="text-xs font-bold px-2.5 py-1 rounded-full" style={`background: ${tierColor}20; color: ${tierColor}; border: 1px solid ${tierColor}40`}>
              {set.tier}{set.wave ? ` W${set.wave}` : ''}
            </span>
            <span class={`text-xs font-bold px-2 py-0.5 rounded ${set.language === 'EN' ? 'bg-blue-500/20 text-blue-400' : 'bg-red-500/20 text-red-400'}`}>
              {set.language === 'EN' ? 'ğŸ‡¬ğŸ‡§ EN' : 'ğŸ‡¨ğŸ‡³ CN'}
            </span>
            <span class="text-xs font-bold px-2 py-0.5 rounded bg-brand-surface-light text-brand-text-muted capitalize">
              {set.type}
            </span>
            {set.arc && (
              <span class="text-xs font-bold px-2 py-0.5 rounded bg-purple-500/20 text-purple-400 border border-purple-500/30">
                âš”ï¸ {set.arc}
              </span>
            )}
          </div>
          <h1 class="text-3xl sm:text-4xl font-bangers tracking-wider text-white mb-1">{set.displayName || set.name}</h1>
          <p class="text-sm text-brand-text-muted max-w-xl">{set.description}</p>

          <div class="flex gap-6 text-center mt-4 flex-wrap">
            <div>
              <div class="text-2xl font-bangers text-brand-orange">{cards.length}</div>
              <div class="text-xs text-brand-text-muted font-semibold uppercase">Cards</div>
            </div>
            {set.packCount && (
              <div>
                <div class="text-2xl font-bangers text-brand-orange">{set.packCount}</div>
                <div class="text-xs text-brand-text-muted font-semibold uppercase">Packs</div>
              </div>
            )}
            {set.packPrice && (
              <div>
                <div class="text-lg font-bangers text-brand-text">{set.packPrice}/pack</div>
                <div class="text-xs text-brand-text-muted font-semibold uppercase">Price</div>
              </div>
            )}
            <div>
              <div class="text-lg font-bangers text-brand-text">{set.releaseDate}</div>
              <div class="text-xs text-brand-text-muted font-semibold uppercase">Released</div>
            </div>
          </div>
        </div>

        <!-- Buy CTA -->
        <div class="shrink-0">
          <BuyButton
            href={link}
            price={price}
            label={`Buy on AliExpress`}
            size="lg"
          />
          <div class="mt-2">
            <AffiliateDisclosure />
          </div>
        </div>
      </div>

      {set.notes && (
        <p class="mt-4 text-xs text-brand-gold bg-brand-gold/10 px-3 py-2 rounded-lg inline-block border border-brand-gold/20">
          ğŸ“Œ {set.notes}
        </p>
      )}

      {set.englishEquivalent && (
        <p class="mt-2 text-xs text-blue-400">
          ğŸ‡¬ğŸ‡§ Also available as <a href={`/sets/${set.englishEquivalent}/`} class="underline hover:text-white">{set.englishEquivalent}</a>
        </p>
      )}
      {set.cnEquivalent && (
        <p class="mt-2 text-xs text-red-400">
          ğŸ‡¨ğŸ‡³ Chinese version: <a href={`/sets/${set.cnEquivalent}/`} class="underline hover:text-white">{set.cnEquivalent}</a>
        </p>
      )}
    </div>
  </div>

  <!-- Unsealed Warning Panel -->
  {isUnsealed && (
    <div class="mb-6 bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 flex items-start gap-3">
      <span class="text-lg shrink-0">â„¹ï¸</span>
      <div>
        <p class="text-sm font-semibold text-blue-400 mb-1">Unsealed Product Notice</p>
        <p class="text-xs text-blue-300/80">
          T4 boxes are <strong>NOT</strong> shrink wrapped. They are sealed with two sticker seals. This is normal and does not mean the box has been opened or tampered with. All T4 products ship this way from KAYOU.
        </p>
      </div>
    </div>
  )}

  <!-- Poor Hit Rate Warning (T2W7 etc.) -->
  {isPoorHitRate && (
    <div class="mb-6 bg-amber-500/10 border border-amber-500/30 rounded-xl p-4 flex items-start gap-3">
      <span class="text-lg shrink-0">âš ï¸</span>
      <div>
        <p class="text-sm font-semibold text-amber-400 mb-1">Poor Hit Rate Warning</p>
        <p class="text-xs text-amber-300/80">
          This set has a significantly lower hit rate than other products in its tier. Community consensus rates this as poor value for money. Consider other options in the same price range. <a href="/start-here" class="underline text-amber-400 hover:text-white">See our recommendations â†’</a>
        </p>
      </div>
    </div>
  )}

  <!-- Pull Rate Card -->
  <div class="mb-6">
    <PullRateCard pullRates={set.pullRates} />
  </div>

  <!-- Value Stars -->
  {set.pullRates && (
    <div class="mb-6 flex items-center gap-2">
      <span class="text-xs font-bold text-brand-text-muted uppercase tracking-wider">Value Rating</span>
      <span class="text-sm text-brand-gold font-mono">
        {'â˜…'.repeat(valueStars)}{'â˜†'.repeat(5 - valueStars)}
      </span>
    </div>
  )}

  <!-- Complete Your Set -->
  <div class="mb-6">
    <CompleteYourSet set={set} cardIds={cardIds} />
  </div>

  <!-- Collection Progress -->
  <div class="mb-6 bg-brand-surface rounded-xl border border-brand-border p-4" id="set-progress">
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm font-semibold text-brand-text-muted">Your Collection</span>
      <span class="text-sm font-mono text-brand-orange" id="progress-count">0 / {cards.length}</span>
    </div>
    <div class="w-full h-2 bg-brand-bg rounded-full overflow-hidden">
      <div class="h-full bg-brand-orange rounded-full transition-all duration-500" id="progress-bar" style="width: 0%"></div>
    </div>
  </div>

  <slot />

  <!-- Pack Contents -->
  {set.packContents && (
    <div class="mt-6 bg-brand-surface rounded-xl border border-brand-border p-4">
      <h3 class="text-xs font-bold text-brand-text-muted uppercase tracking-wider mb-2">Pack Contents</h3>
      <p class="text-sm text-white">{set.packContents}</p>
    </div>
  )}

  <!-- Report missing card -->
  <div class="mt-8 text-center">
    <a href={`mailto:report@narutocollector.com?subject=Missing card in ${set.name}`} class="text-xs text-brand-text-muted hover:text-brand-orange transition-colors">
      ğŸ“ Report a missing card in this set
    </a>
  </div>

  <script define:vars={{ cardIds, totalCards: cards.length }}>
    function updateProgress() {
      try {
        const raw = localStorage.getItem('naruto-collector-v2') || localStorage.getItem('naruto-collector-v2');
        if (!raw) return;
        const data = JSON.parse(raw);
        const owned = cardIds.filter(id => data.owned && data.owned[id]).length;
        const pct = totalCards > 0 ? Math.round((owned / totalCards) * 100) : 0;
        document.getElementById('progress-count').textContent = `${owned} / ${totalCards}`;
        document.getElementById('progress-bar').style.width = `${pct}%`;
      } catch(e) {}
    }
    updateProgress();
    window.addEventListener('collection-updated', updateProgress);
  </script>
</BaseLayout>
